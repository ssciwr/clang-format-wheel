name: Build + Release Wheels

on: push

env:
  USE_QEMU: ${{ github.event.inputs.use_qemu == 'true' }}
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  build-wheels:
    name: "${{ matrix.os }} :: ${{ matrix.arch }} (skip: ${{ matrix.skip }})"
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: windows-latest
            arch: "AMD64"
            use_qemu: false
            skip: ""
          - os: windows-latest
            arch: "x86"
            use_qemu: false
            skip: ""

    steps:
    - uses: actions/checkout@v4
      if: (!matrix.use_qemu) || fromJSON(env.USE_QEMU)
    
    - name: Support long paths
      if: runner.os == 'Windows' && ((!matrix.use_qemu) || fromJSON(env.USE_QEMU))
      run: git config --system core.longpaths true

    - name: Override LLVM version (${{ github.event.inputs.llvm_version }})
      if: github.event.inputs.llvm_version
      run: |
        echo "${{ github.event.inputs.llvm_version }}.${{ github.event.inputs.wheel_version }}" > clang-format_version.txt
        cat clang-format_version.txt

    - name: Build wheels
      uses: pypa/cibuildwheel@v2.16
      if: (!matrix.use_qemu) || fromJSON(env.USE_QEMU)
      env:
        CIBW_ARCHS: "${{ matrix.arch }}"
        CIBW_SKIP: "${{ matrix.skip }}"